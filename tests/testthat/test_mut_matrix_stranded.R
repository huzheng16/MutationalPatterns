context("Function 'mut_matrix_stranded'")

genes_hg19 <- genes(TxDb.Hsapiens.UCSC.hg19.knownGene)

vcf_files <- list.files(system.file("extdata", package="MutationalPatterns"),
                        pattern = ".vcf", full.names = TRUE)

sample_names <- c("colon1", "colon2", "colon3",
                  "intestine1", "intestine2", "intestine3",
                  "liver1", "liver2", "liver3")

ref_genome <- "BSgenome.Hsapiens.UCSC.hg19"
library(ref_genome, character.only = TRUE)
vcfs <- read_vcfs_as_granges(vcf_files, sample_names, ref_genome)


test_that("transforms correctly", {
    expected <- matrix(c(0, 2, 1, 1, 1, 0, 0, 1, 1, 2,
                         0, 0, 0, 0, 0, 0, 1, 1, 0, 0,
                         0, 0, 0, 0, 0, 0, 1, 2, 0, 1,
                         1, 4, 1, 1, 0, 3, 0, 0, 0, 3,
                         1, 0, 0, 1, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
                         0, 0, 1, 0, 3, 2, 5, 0, 20, 8,
                         1, 3, 1, 1, 2, 3, 7, 7, 2, 4,
                         2, 0, 2, 2, 6, 4, 0, 0, 2, 0,
                         1, 0, 1, 2, 3, 3, 0, 1, 0, 1,
                         1, 1, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 1, 0, 0, 3, 3,
                         0, 1, 1, 2, 2, 2, 1, 0, 0, 1,
                         0, 0, 0, 3, 1, 1, 0, 0, 1, 0,
                         1, 0, 0, 1, 0, 0, 1, 0, 1, 3,
                         0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
                         0, 1, 0, 0, 2, 0, 1, 0, 1, 1,
                         0, 0, 0, 0, 0, 1, 1, 0, 0, 1,
                         1, 0, 1, 0, 1, 1, 0, 1, 0, 1,
                         0, 1, 1, 0, 0, 1, 1, 0, 0, 0,
                         1, 0, 0, 2, 0, 0, 0, 1, 1, 1,
                         0, 1, 0, 2, 1, 1, 0, 1, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                         0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
                         0, 0, 0, 0, 0, 0, 3, 0, 1, 1,
                         11, 15, 1, 1, 3, 3, 2, 1, 7, 6,
                         2, 7, 0, 0, 2, 2, 3, 6, 1, 0,
                         1, 0, 2, 5, 8, 3, 3, 0, 2, 2,
                         1, 0, 0, 2, 1, 1, 1, 0, 1, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 1, 0, 1, 0, 1, 0, 1,
                         1, 3, 0, 0, 0, 2, 3, 0, 0, 0,
                         0, 3, 2, 0, 1, 0, 2, 0, 1, 1,
                         3, 0, 1, 1, 1, 0, 1, 0, 1, 0,
                         0, 2, 0, 0, 0, 1, 1, 0, 1, 0,
                         1, 0, 0, 0, 0, 0, 1, 0, 1, 0,
                         0, 0, 0, 0, 0, 0, 1, 1, 1, 0,
                         1, 1, 2, 0, 1, 2, 1, 1, 0, 0,
                         0, 0, 1, 4, 0, 0, 0, 0, 0, 0,
                         1, 0, 0, 1, 0, 0, 0, 1, 0, 0,
                         1, 1, 0, 2, 1, 4, 0, 1, 0, 1,
                         1, 0, 0, 1, 0, 0, 0, 1, 0, 1,
                         1, 0, 0, 0, 0, 0, 0, 0, 1, 1,
                         0, 0, 0, 0, 0, 0, 0, 3, 0, 3,
                         2, 2, 10, 8, 1, 3, 1, 2, 1, 1,
                         3, 8, 2, 2, 1, 3, 2, 3, 9, 4,
                         3, 0, 2, 0, 2, 2, 6, 4, 2, 1,
                         0, 0, 1, 0, 1, 2, 0, 1, 0, 1,
                         0, 1, 0, 1, 1, 0, 0, 0, 0, 0,
                         0, 0, 1, 0, 0, 0, 0, 1, 0, 0,
                         1, 2, 2, 3, 0, 0, 0, 2, 3, 5,
                         0, 0, 0, 1, 1, 0, 1, 0, 1, 3,
                         2, 1, 1, 0, 0, 0, 0, 1, 0, 0,
                         0, 1, 0, 1, 1, 0, 0, 1, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 1, 0, 0,
                         0, 0, 2, 2, 1, 0, 1, 1, 1, 2,
                         0, 1, 0, 1, 0, 3, 1, 1, 0, 1,
                         2, 0, 1, 0, 0, 1, 0, 0, 0, 0,
                         0, 2, 1, 1, 1, 1, 0, 0, 0, 1,
                         1, 0, 1, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 1, 1, 0, 0, 0, 0, 0,
                         0, 1, 1, 0, 0, 0, 0, 0, 0, 2,
                         1, 1, 0, 1, 12, 11, 0, 1, 3, 1,
                         2, 2, 4, 6, 1, 4, 1, 0, 1, 2,
                         8, 6, 0, 0, 2, 1, 0, 3, 3, 7,
                         3, 1, 1, 1, 1, 0, 0, 0, 0, 2,
                         0, 0, 0, 0, 0, 1, 2, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                         0, 0, 1, 2, 0, 4, 0, 0, 1, 3,
                         4, 2, 0, 1, 1, 0, 3, 1, 1, 1,
                         1, 0, 0, 0, 5, 0, 0, 0, 0, 0,
                         0, 0, 0, 1, 0, 2, 0, 0, 0, 0,
                         0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
                         1, 1, 0, 0, 0, 1, 1, 0, 1, 3,
                         1, 0, 0, 0, 1, 1, 0, 2, 0, 0,
                         0, 0, 0, 0, 2, 0, 1, 0, 0, 1,
                         0, 0, 0, 0, 0, 1, 0, 0, 2, 0,
                         1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
                         0, 1, 0, 0, 1, 0, 1, 0, 0, 0,
                         0, 0, 0, 0, 1, 0, 0, 0, 0, 0,
                         1, 2, 5, 3, 1, 2, 4, 9, 0, 3,
                         1, 0, 2, 3, 7, 4, 2, 1, 1, 2,
                         2, 2, 3, 3, 1, 3, 1, 1, 2, 4,
                         4, 6, 7, 3, 0, 0, 1, 0, 2, 1,
                         0, 1, 1, 1, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 1, 0,
                         0, 0, 0, 0, 1, 0, 3, 4, 0, 1,
                         0, 1, 0, 1, 0, 0, 0, 1, 0, 0,
                         1, 2, 2, 1, 0, 1, 0, 0, 0, 0,
                         1, 0, 0, 0, 1, 0, 0, 2, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
                         1, 0, 0, 0, 0, 0, 1, 0, 0, 0,
                         0, 0, 0, 1, 0, 0, 0, 1, 1, 0,
                         0, 2, 1, 2, 0, 0, 0, 0, 0, 1,
                         1, 0, 0, 0, 1, 0, 0, 0, 0, 0,
                         0, 1, 1, 0, 0, 1, 1, 1, 1, 2,
                         1, 3, 0, 1, 0, 0, 1, 0, 0, 0,
                         1, 0, 0, 1, 0, 0, 1, 0, 2, 0,
                         0, 0, 0, 0, 0, 1, 1, 1, 0, 0,
                         0, 0, 2, 0, 3, 1, 4, 2, 11, 8,
                         2, 2, 2, 1, 1, 2, 6, 6, 0, 4,
                         3, 0, 0, 3, 7, 9, 1, 0, 1, 1,
                         2, 0, 5, 1, 0, 1, 1, 0, 1, 0,
                         0, 0, 0, 1, 0, 0, 1, 0, 0, 0,
                         1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         1, 1, 0, 1, 0, 1, 0, 0, 1, 4,
                         0, 0, 1, 1, 1, 2, 1, 1, 1, 1,
                         1, 1, 1, 1, 2, 1, 0, 2, 0, 1,
                         0, 1, 0, 0, 0, 0, 1, 0, 0, 0,
                         0, 1, 0, 0, 1, 0, 1, 0, 1, 0,
                         0, 0, 1, 1, 0, 0, 0, 0, 1, 0,
                         0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
                         0, 2, 3, 2, 0, 0, 0, 0, 0, 0,
                         1, 1, 1, 1, 0, 0, 1, 0, 2, 1,
                         0, 1, 0, 1, 0, 1, 0, 1, 2, 1,
                         0, 1, 1, 4, 1, 1, 0, 0, 1, 0,
                         0, 1, 2, 0, 0, 2, 0, 1, 1, 2,
                         0, 0, 0, 0, 0, 0, 1, 0, 1, 0,
                         0, 0, 0, 0, 2, 1, 2, 0, 2, 2,
                         9,10, 0, 4, 1, 1, 0, 3, 1, 4,
                         0, 4, 2, 0, 2, 3, 9, 4, 4, 0,
                         2, 2, 2, 1, 4, 4, 3, 1, 0, 0,
                         1, 0, 0, 0, 0, 0, 0, 1, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 1, 0, 0, 0, 0, 0, 0, 0,
                         0, 2, 0, 0, 1, 0, 1, 1, 0, 1,
                         1, 1, 1, 0, 0, 2, 0, 1, 1, 0,
                         1, 1, 1, 1, 1, 0, 0, 1, 0, 1,
                         0, 1, 0, 0, 1, 0, 0, 0, 1, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 1, 0, 1, 0,
                         2, 0, 2, 1, 1, 2, 1, 2, 0, 1,
                         0, 0, 0, 0, 0, 1, 0, 1, 0, 0,
                         0, 0, 1, 0, 0, 0, 2, 0, 0, 0,
                         0, 1, 1, 0, 1, 2, 0, 1, 0, 0,
                         0, 0, 0, 1, 0, 0, 0, 1, 0, 0,
                         0, 1, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 1, 0, 0, 0, 0, 0, 2, 2, 1,
                         3, 2, 12, 7, 1, 0, 2, 3, 1, 2,
                         6, 7, 2, 3, 2, 3, 1, 1, 4, 4,
                         3, 2, 1, 1, 1, 2, 6, 5, 0, 1,
                         1, 0, 0, 0, 0, 1, 0, 1, 0, 1,
                         1, 0, 0, 1, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 1, 2, 4, 1, 0, 2, 3, 2, 4,
                         1, 1, 0, 0, 1, 0, 2, 0, 2, 0,
                         0, 0, 1, 1, 0, 0, 0, 2, 0, 0,
                         2, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 1, 1, 0,
                         1, 0, 0, 1, 1, 0, 0, 3, 1, 1,
                         0, 0, 0, 2, 0, 1, 0, 0, 1, 0,
                         1, 0, 0, 1, 0, 1, 1, 1, 0, 0,
                         0, 1, 1, 1, 0, 2, 2, 2, 1, 1,
                         1, 2, 0, 0, 0, 3, 0, 0, 0, 1,
                         0, 0, 1, 0, 0, 0, 1, 0, 0, 0,
                         0, 0, 1, 0, 0, 0, 0, 0, 2, 1,
                         0, 1, 3, 0, 15, 15, 1, 0, 2, 1,
                         1, 1, 5, 6, 4, 3, 0, 1, 1, 3,
                         7, 2, 1, 1, 0, 4, 0, 2, 9, 3,
                         3, 2, 0, 1, 1, 1, 0, 1, 0, 1,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                         0, 1, 0, 2, 2, 2, 0, 0, 3, 1,
                         0, 2, 0, 1, 0, 0, 2, 1, 2, 2,
                         2, 0, 0, 0, 0, 0, 1, 1, 0, 1,
                         0, 0, 1, 1, 1, 2, 0, 1, 1, 0,
                         0, 0, 0, 0, 0, 1, 0, 0, 0, 0,
                         2, 0, 1, 0, 0, 0, 0, 0, 0, 0,
                         0, 1, 1, 0, 1, 0, 0, 0),
                       nrow=192,
                       ncol=9)

    dimnames(expected) <- list(
        c("ACA-u", "ACA-t", "ACC-u", "ACC-t", "ACG-u", "ACG-t",
          "ACT-u", "ACT-t", "CCA-u", "CCA-t", "CCC-u", "CCC-t",
          "CCG-u", "CCG-t", "CCT-u", "CCT-t", "GCA-u", "GCA-t",
          "GCC-u", "GCC-t", "GCG-u", "GCG-t", "GCT-u", "GCT-t",
          "TCA-u", "TCA-t", "TCC-u", "TCC-t", "TCG-u", "TCG-t",
          "TCT-u", "TCT-t", "ACA-u", "ACA-t", "ACC-u", "ACC-t",
          "ACG-u", "ACG-t", "ACT-u", "ACT-t", "CCA-u", "CCA-t",
          "CCC-u", "CCC-t", "CCG-u", "CCG-t", "CCT-u", "CCT-t",
          "GCA-u", "GCA-t", "GCC-u", "GCC-t", "GCG-u", "GCG-t",
          "GCT-u", "GCT-t", "TCA-u", "TCA-t", "TCC-u", "TCC-t",
          "TCG-u", "TCG-t", "TCT-u", "TCT-t", "ACA-u", "ACA-t",
          "ACC-u", "ACC-t", "ACG-u", "ACG-t", "ACT-u", "ACT-t",
          "CCA-u", "CCA-t", "CCC-u", "CCC-t", "CCG-u", "CCG-t",
          "CCT-u", "CCT-t", "GCA-u", "GCA-t", "GCC-u", "GCC-t",
          "GCG-u", "GCG-t", "GCT-u", "GCT-t", "TCA-u", "TCA-t",
          "TCC-u", "TCC-t", "TCG-u", "TCG-t", "TCT-u", "TCT-t",
          "ATA-u", "ATA-t", "ATC-u", "ATC-t", "ATG-u", "ATG-t",
          "ATT-u", "ATT-t", "CTA-u", "CTA-t", "CTC-u", "CTC-t",
          "CTG-u", "CTG-t", "CTT-u", "CTT-t", "GTA-u", "GTA-t",
          "GTC-u", "GTC-t", "GTG-u", "GTG-t", "GTT-u", "GTT-t",
          "TTA-u", "TTA-t", "TTC-u", "TTC-t", "TTG-u", "TTG-t",
          "TTT-u", "TTT-t", "ATA-u", "ATA-t", "ATC-u", "ATC-t",
          "ATG-u", "ATG-t", "ATT-u", "ATT-t", "CTA-u", "CTA-t",
          "CTC-u", "CTC-t", "CTG-u", "CTG-t", "CTT-u", "CTT-t",
          "GTA-u", "GTA-t", "GTC-u", "GTC-t", "GTG-u", "GTG-t",
          "GTT-u", "GTT-t", "TTA-u", "TTA-t", "TTC-u", "TTC-t",
          "TTG-u", "TTG-t", "TTT-u", "TTT-t", "ATA-u", "ATA-t",
          "ATC-u", "ATC-t", "ATG-u", "ATG-t", "ATT-u", "ATT-t",
          "CTA-u", "CTA-t", "CTC-u", "CTC-t", "CTG-u", "CTG-t",
          "CTT-u", "CTT-t", "GTA-u", "GTA-t", "GTC-u", "GTC-t",
          "GTG-u", "GTG-t", "GTT-u", "GTT-t", "TTA-u", "TTA-t",
          "TTC-u", "TTC-t", "TTG-u", "TTG-t", "TTT-u", "TTT-t"),
        c("colon1", "colon2", "colon3", "intestine1", "intestine2",
          "intestine3", "liver1", "liver2", "liver3"))

    actual <- mut_matrix_stranded(vcfs, ref_genome, genes_hg19)
    expect_that(actual, equals(expected))
})
